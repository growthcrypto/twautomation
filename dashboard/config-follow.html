<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Follow/Unfollow Config</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { background: #0f172a; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
    </style>
</head>
<body class="min-h-screen p-8">
    <div class="max-w-5xl mx-auto">
        <div class="mb-6">
            <a href="index.html" class="text-blue-400 hover:text-blue-300">
                <i class="fas fa-arrow-left mr-2"></i>Back to Dashboard
            </a>
        </div>

        <div class="bg-gray-900 border border-gray-800 rounded-lg p-8">
            <h1 class="text-3xl font-bold text-white mb-2">
                <i class="fas fa-user-plus text-blue-400 mr-3"></i>Follow/Unfollow Campaign Configuration
            </h1>
            <p class="text-gray-400 mb-8">Configure automated following for traffic generation</p>

            <form id="followConfigForm" class="space-y-8">
                
                <!-- Basic Settings -->
                <div class="bg-gray-800 p-6 rounded-lg">
                    <h3 class="text-lg font-bold text-white mb-4">Basic Settings</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="col-span-2">
                            <label class="block text-sm font-medium text-gray-300 mb-2">Campaign Name *</label>
                            <input type="text" name="name" required class="w-full bg-gray-700 border border-gray-600 rounded px-4 py-2 text-white" placeholder="Soccer Follow Campaign">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Status</label>
                            <select name="enabled" class="w-full bg-gray-700 border border-gray-600 rounded px-4 py-2 text-white">
                                <option value="true">Enabled</option>
                                <option value="false">Disabled</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Niche</label>
                            <select name="niche" class="w-full bg-gray-700 border border-gray-600 rounded px-4 py-2 text-white">
                                <option value="">Any</option>
                                <option value="soccer">Soccer</option>
                                <option value="politics">Politics</option>
                                <option value="gaming">Gaming</option>
                                <option value="fitness">Fitness</option>
                                <option value="crypto">Crypto</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Daily Limits -->
                <div class="bg-gray-800 p-6 rounded-lg">
                    <h3 class="text-lg font-bold text-white mb-4">Daily Limits</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Max Follows Per Day</label>
                            <input type="number" name="maxFollowsPerDay" value="100" min="1" max="400" class="w-full bg-gray-700 border border-gray-600 rounded px-4 py-2 text-white">
                            <p class="text-xs text-gray-500 mt-1">Twitter allows 400, recommend 50-100 to stay safe</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Max Unfollows Per Day</label>
                            <input type="number" name="maxUnfollowsPerDay" value="100" min="1" max="400" class="w-full bg-gray-700 border border-gray-600 rounded px-4 py-2 text-white">
                        </div>
                    </div>
                </div>

                <!-- Timing Controls -->
                <div class="bg-gray-800 p-6 rounded-lg">
                    <h3 class="text-lg font-bold text-white mb-4">Timing Controls</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Delay Between Follows (Min Seconds)</label>
                            <input type="number" name="delayMin" value="30" min="5" max="300" class="w-full bg-gray-700 border border-gray-600 rounded px-4 py-2 text-white">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Delay Between Follows (Max Seconds)</label>
                            <input type="number" name="delayMax" value="120" min="10" max="600" class="w-full bg-gray-700 border border-gray-600 rounded px-4 py-2 text-white">
                            <p class="text-xs text-gray-500 mt-1">System picks random delay in this range</p>
                        </div>
                    </div>
                </div>

                <!-- Break System -->
                <div class="bg-gray-800 p-6 rounded-lg">
                    <h3 class="text-lg font-bold text-white mb-4">Break System</h3>
                    <div class="space-y-4">
                        <label class="flex items-center gap-3">
                            <input type="checkbox" name="breaksEnabled" checked class="w-5 h-5">
                            <span class="text-gray-300">Enable automatic breaks</span>
                        </label>
                        <div class="grid grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Take Break After X Actions</label>
                                <input type="number" name="breakAfterActions" value="20" min="5" max="100" class="w-full bg-gray-700 border border-gray-600 rounded px-4 py-2 text-white">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Break Duration (Min Minutes)</label>
                                <input type="number" name="breakDurationMin" value="5" min="1" max="60" class="w-full bg-gray-700 border border-gray-600 rounded px-4 py-2 text-white">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Break Duration (Max Minutes)</label>
                                <input type="number" name="breakDurationMax" value="15" min="1" max="120" class="w-full bg-gray-700 border border-gray-600 rounded px-4 py-2 text-white">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Active Hours -->
                <div class="bg-gray-800 p-6 rounded-lg">
                    <h3 class="text-lg font-bold text-white mb-4">Active Hours</h3>
                    <div class="grid grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Start Time</label>
                            <input type="time" name="activeStart" value="08:00" class="w-full bg-gray-700 border border-gray-600 rounded px-4 py-2 text-white">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">End Time</label>
                            <input type="time" name="activeEnd" value="22:00" class="w-full bg-gray-700 border border-gray-600 rounded px-4 py-2 text-white">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Timezone</label>
                            <select name="timezone" class="w-full bg-gray-700 border border-gray-600 rounded px-4 py-2 text-white">
                                <option value="America/New_York">Eastern Time</option>
                                <option value="America/Chicago">Central Time</option>
                                <option value="America/Denver">Mountain Time</option>
                                <option value="America/Los_Angeles">Pacific Time</option>
                                <option value="Europe/London">London</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Follow-Back Checker -->
                <div class="bg-gray-800 p-6 rounded-lg">
                    <h3 class="text-lg font-bold text-white mb-4">Follow-Back Checker</h3>
                    <div class="space-y-4">
                        <label class="flex items-center gap-3">
                            <input type="checkbox" name="followBackEnabled" checked class="w-5 h-5">
                            <span class="text-gray-300">Enable follow-back checking</span>
                        </label>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Check After Days</label>
                                <input type="number" name="checkAfterDays" value="3" min="1" max="14" class="w-full bg-gray-700 border border-gray-600 rounded px-4 py-2 text-white">
                            </div>
                            <div class="flex items-end">
                                <label class="flex items-center gap-3">
                                    <input type="checkbox" name="unfollowIfNoFollowBack" checked class="w-5 h-5">
                                    <span class="text-gray-300">Unfollow if no follow-back</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Target Sources -->
                <div class="bg-gray-800 p-6 rounded-lg">
                    <h3 class="text-lg font-bold text-white mb-4">Target Sources</h3>
                    <p class="text-gray-400 text-sm mb-4">Where to find users to follow</p>
                    <div id="targetSources" class="space-y-3">
                        <div class="target-source-row flex gap-3">
                            <select name="sourceType[]" class="bg-gray-700 border border-gray-600 rounded px-4 py-2 text-white">
                                <option value="community">Community</option>
                                <option value="hashtag">Hashtag</option>
                                <option value="follower_scrape">Follower List</option>
                                <option value="likes_scrape">Users Who Liked Tweet</option>
                            </select>
                            <input type="text" name="sourceValue[]" placeholder="Community ID or #hashtag" class="flex-1 bg-gray-700 border border-gray-600 rounded px-4 py-2 text-white">
                            <input type="number" name="sourceWeight[]" value="100" min="1" max="100" placeholder="Weight %" class="w-24 bg-gray-700 border border-gray-600 rounded px-4 py-2 text-white">
                            <button type="button" onclick="removeSource(this)" class="text-red-400 hover:text-red-300 px-3">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    <button type="button" onclick="addSource()" class="mt-3 text-blue-400 hover:text-blue-300 text-sm">
                        <i class="fas fa-plus mr-2"></i>Add Another Source
                    </button>
                </div>

                <!-- Quality Filters -->
                <div class="bg-gray-800 p-6 rounded-lg">
                    <h3 class="text-lg font-bold text-white mb-4">Quality Filters</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <label class="flex items-center gap-3">
                            <input type="checkbox" name="skipIfPrivate" checked class="w-5 h-5">
                            <span class="text-gray-300">Skip private accounts</span>
                        </label>
                        <label class="flex items-center gap-3">
                            <input type="checkbox" name="skipIfNoProfilePic" checked class="w-5 h-5">
                            <span class="text-gray-300">Skip accounts without profile pic</span>
                        </label>
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Min Followers</label>
                            <input type="number" name="skipIfLowFollowers" value="10" min="0" class="w-full bg-gray-700 border border-gray-600 rounded px-4 py-2 text-white">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Max Following</label>
                            <input type="number" name="skipIfHighFollowing" value="5000" min="0" class="w-full bg-gray-700 border border-gray-600 rounded px-4 py-2 text-white">
                        </div>
                    </div>
                </div>

                <!-- Random Activity -->
                <div class="bg-gray-800 p-6 rounded-lg">
                    <h3 class="text-lg font-bold text-white mb-4">Random Activity (Makes Account Look Human)</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="flex items-center gap-3 mb-2">
                                <input type="checkbox" name="viewProfileEnabled" checked class="w-5 h-5">
                                <span class="text-gray-300">View target profile before following</span>
                            </label>
                            <div class="grid grid-cols-2 gap-4 ml-8">
                                <div>
                                    <label class="block text-xs text-gray-400 mb-1">Min Scroll Time (seconds)</label>
                                    <input type="number" name="viewProfileScrollMin" value="2" min="1" max="30" class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white text-sm">
                                </div>
                                <div>
                                    <label class="block text-xs text-gray-400 mb-1">Max Scroll Time (seconds)</label>
                                    <input type="number" name="viewProfileScrollMax" value="8" min="1" max="60" class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white text-sm">
                                </div>
                            </div>
                        </div>
                        <div>
                            <label class="flex items-center gap-3 mb-2">
                                <input type="checkbox" name="likeProfileEnabled" checked class="w-5 h-5">
                                <span class="text-gray-300">Sometimes like target's recent tweet</span>
                            </label>
                            <div class="ml-8">
                                <label class="block text-xs text-gray-400 mb-1">Probability (%)</label>
                                <input type="number" name="likeProfileProbability" value="30" min="0" max="100" class="w-32 bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white text-sm">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Error Handling -->
                <div class="bg-gray-800 p-6 rounded-lg">
                    <h3 class="text-lg font-bold text-white mb-4">Error Handling</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Max Consecutive Errors</label>
                            <input type="number" name="maxConsecutiveErrors" value="3" min="1" max="10" class="w-full bg-gray-700 border border-gray-600 rounded px-4 py-2 text-white">
                            <p class="text-xs text-gray-500 mt-1">Pause campaign after X errors in a row</p>
                        </div>
                        <div class="flex items-end">
                            <label class="flex items-center gap-3">
                                <input type="checkbox" name="pauseOnError" checked class="w-5 h-5">
                                <span class="text-gray-300">Pause campaign on repeated errors</span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Apply To Accounts -->
                <div class="bg-gray-800 p-6 rounded-lg">
                    <h3 class="text-lg font-bold text-white mb-4">Apply To Accounts</h3>
                    <p class="text-gray-400 text-sm mb-3">Select which accounts should use this config</p>
                    <div id="accountsList" class="space-y-2">
                        <p class="text-gray-500 text-sm">Loading accounts...</p>
                    </div>
                </div>

                <!-- Submit -->
                <div class="flex gap-4">
                    <button type="submit" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-4 rounded-lg font-bold text-lg">
                        <i class="fas fa-save mr-2"></i>Save Configuration
                    </button>
                    <a href="index.html" class="flex-1 bg-gray-700 hover:bg-gray-600 text-white py-4 rounded-lg font-bold text-lg text-center">
                        Cancel
                    </a>
                </div>
            </form>
        </div>
    </div>

    <script>
        const API_URL = window.location.origin + '/api';

        // Add/remove source rows
        function addSource() {
            const container = document.getElementById('targetSources');
            const newRow = document.createElement('div');
            newRow.className = 'target-source-row flex gap-3';
            newRow.innerHTML = `
                <select name="sourceType[]" class="bg-gray-700 border border-gray-600 rounded px-4 py-2 text-white">
                    <option value="community">Community</option>
                    <option value="hashtag">Hashtag</option>
                    <option value="follower_scrape">Follower List</option>
                    <option value="likes_scrape">Users Who Liked Tweet</option>
                </select>
                <input type="text" name="sourceValue[]" placeholder="Community ID or #hashtag" class="flex-1 bg-gray-700 border border-gray-600 rounded px-4 py-2 text-white">
                <input type="number" name="sourceWeight[]" value="100" min="1" max="100" placeholder="Weight %" class="w-24 bg-gray-700 border border-gray-600 rounded px-4 py-2 text-white">
                <button type="button" onclick="removeSource(this)" class="text-red-400 hover:text-red-300 px-3">
                    <i class="fas fa-trash"></i>
                </button>
            `;
            container.appendChild(newRow);
        }

        function removeSource(btn) {
            btn.closest('.target-source-row').remove();
        }

        // Load accounts for assignment
        async function loadAccounts() {
            try {
                const response = await fetch(`${API_URL}/accounts`);
                const data = await response.json();

                const container = document.getElementById('accountsList');
                
                if (!data.accounts || data.accounts.length === 0) {
                    container.innerHTML = '<p class="text-gray-500 text-sm">No accounts registered yet. Register accounts first.</p>';
                    return;
                }

                // Filter to show only traffic role accounts (they do follow/unfollow)
                const followAccounts = data.accounts.filter(a => a.role === 'traffic');

                if (followAccounts.length === 0) {
                    container.innerHTML = '<p class="text-gray-500 text-sm">No Follow/Unfollow accounts registered yet.</p>';
                    return;
                }

                container.innerHTML = followAccounts.map(acc => `
                    <label class="flex items-center gap-3 p-3 bg-gray-700 rounded hover:bg-gray-600 cursor-pointer">
                        <input type="checkbox" name="accountIds[]" value="${acc._id}" class="w-5 h-5">
                        <div class="flex-1">
                            <div class="text-white font-medium">@${acc.username}</div>
                            <div class="text-gray-400 text-xs">${acc.niche || 'general'} | ${acc.status}</div>
                        </div>
                    </label>
                `).join('');

            } catch (error) {
                console.error('Error loading accounts:', error);
            }
        }

        // Form submission
        document.getElementById('followConfigForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const formData = new FormData(e.target);
            
            // Build config object
            const config = {
                name: formData.get('name'),
                enabled: formData.get('enabled') === 'true',
                niche: formData.get('niche') || null,
                maxFollowsPerDay: parseInt(formData.get('maxFollowsPerDay')),
                maxUnfollowsPerDay: parseInt(formData.get('maxUnfollowsPerDay')),
                delayBetweenFollows: {
                    min: parseInt(formData.get('delayMin')),
                    max: parseInt(formData.get('delayMax'))
                },
                breaks: {
                    enabled: formData.get('breaksEnabled') === 'on',
                    afterActions: parseInt(formData.get('breakAfterActions')),
                    breakDuration: {
                        min: parseInt(formData.get('breakDurationMin')) * 60,
                        max: parseInt(formData.get('breakDurationMax')) * 60
                    }
                },
                activeHours: {
                    start: formData.get('activeStart'),
                    end: formData.get('activeEnd'),
                    timezone: formData.get('timezone')
                },
                followBackChecker: {
                    enabled: formData.get('followBackEnabled') === 'on',
                    checkAfterDays: parseInt(formData.get('checkAfterDays')),
                    unfollowIfNoFollowBack: formData.get('unfollowIfNoFollowBack') === 'on'
                },
                targetSources: [],
                randomActivity: {
                    viewProfile: {
                        enabled: formData.get('viewProfileEnabled') === 'on',
                        scrollTime: {
                            min: parseInt(formData.get('viewProfileScrollMin')),
                            max: parseInt(formData.get('viewProfileScrollMax'))
                        }
                    },
                    likeTargetProfile: {
                        enabled: formData.get('likeProfileEnabled') === 'on',
                        probability: parseInt(formData.get('likeProfileProbability'))
                    }
                },
                skipIfPrivate: formData.get('skipIfPrivate') === 'on',
                skipIfNoProfilePic: formData.get('skipIfNoProfilePic') === 'on',
                skipIfLowFollowers: parseInt(formData.get('skipIfLowFollowers')),
                skipIfHighFollowing: parseInt(formData.get('skipIfHighFollowing')),
                maxConsecutiveErrors: parseInt(formData.get('maxConsecutiveErrors')),
                pauseOnError: formData.get('pauseOnError') === 'on',
                accountIds: formData.getAll('accountIds[]')
            };

            // Build target sources
            const types = formData.getAll('sourceType[]');
            const values = formData.getAll('sourceValue[]');
            const weights = formData.getAll('sourceWeight[]');

            for (let i = 0; i < types.length; i++) {
                if (values[i]) {
                    config.targetSources.push({
                        type: types[i],
                        value: values[i],
                        weight: parseInt(weights[i])
                    });
                }
            }

            try {
                const response = await fetch(`${API_URL}/configs/follow-unfollow`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(config)
                });

                const result = await response.json();

                if (result.success) {
                    alert('✅ Follow/Unfollow configuration saved!');
                    window.location.href = 'index.html';
                } else {
                    alert('❌ Error: ' + result.error);
                }
            } catch (error) {
                alert('❌ Error: ' + error.message);
            }
        });

        // Load accounts on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadAccounts();
        });
    </script>
</body>
</html>

